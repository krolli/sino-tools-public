<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Character sheet</title>
		<link rel="stylesheet" type="text/css" href="styles.css">
	</head>
	<body>
		<script>

let repo_datamine = "sinoalice-datamine/data/master/EN";
let repo_public_tools = "krolli/sino-tools-public/main";
let db = {
	json: {
		loadingCount: 0,
		match_history_Melesie: null,
		ultimate_art_method_mst_list: null,
	},
	index: {
		shinma_skills: null,
	}
};

const shinma_weapon_map = [
	'',
	'I', 'T', 'A', 'S',
	'B', 'H', 'P', 'P',
];

function generateShinmaCells(shinma, shinma_skills) {
	if (!shinma) {
		return '<td align="center"></td><td align="center"></td>';
	}

	let shinma_mst = shinma_skills[shinma.art_mst_id];
	let shinma_weapons =
		shinma_weapon_map[shinma_mst.element1] +
		shinma_weapon_map[shinma_mst.element2] +
		shinma_weapon_map[shinma_mst.element3] +
		shinma_weapon_map[shinma_mst.element4];

	return `<td align="center">${shinma_weapons}</td>` +
		`<td align="center">${shinma.guild_a_count}/${shinma.guild_b_count}</td>`;
}

function onLoadingDone(db) {
	let remaining = --db.json.loadingCount;
	if (remaining > 0)
		return;

	let match_history = db.json.match_history_Melesie;
	let shinma_table = db.json.ultimate_art_method_mst_list;

	db.index.shinma_skills = {};
	let shinma_skills = db.index.shinma_skills;
	for (let i = 0; i < shinma_table.length; i++) {
		let shinma_mst = shinma_table[i];
		shinma_skills[shinma_mst.ultimateArtMethodMstId] = shinma_mst;
	}

	let html = "<h1>Match history</h1>";
	html += '<table><tr>';
	html += '<th>Date</th>';
	html += '<th>Rank</th>';
	html += '<th>Result</th>';
	html += '<th>Enemy Guild</th>';
	html += '<th>Guild ID</th>';
	html += '<th>Daydreamer (Lifeforce)</th>';
	html += '<th>Enemy Guild (Lifeforce)</th>';
	html += '<th>Daydreamer (Combo)</th>';
	html += '<th>Enemy Guild (Combo)</th>';
	html += '<th>Daydreamer (Ship)</th>';
	html += '<th>Enemy Guild (Ship)</th>';
	html += '<th>1st Shinma</th>';
	html += '<th>Tally</th>';
	html += '<th>2nd Shinma</th>';
	html += '<th>Tally</th>';
	html += '</tr>';

	let match_count = match_history.items.length;
	for (let i = match_count-1; i >= 0; i--) {
		let m = match_history.items[i];
		let dt = new Date(m.start_time * 1000);

		let result = "Tie";
		if (m.guild_a_points > m.guild_b_points)
			result = "Victory";
		else if (m.guild_a_points < m.guild_b_points)
			result = "Defeat";

		html += '<tr>';
		html += `<td>${dt.getUTCFullYear()}/${dt.getUTCMonth()+1}/${dt.getUTCDate()}</td>`;
		html += `<td>${m.rank}</td>`;
		html += `<td>${result}</td>`;
		html += `<td>${m.guild_b_name}</td>`;
		html += `<td align="right">${m.guild_b_id}</td>`;
		html += `<td align="right">${m.guild_a_points.toLocaleString('en-US')}</td>`;
		html += `<td align="right">${m.guild_b_points.toLocaleString('en-US')}</td>`;
		html += `<td align="right">${m.guild_a_combo}</td>`;
		html += `<td align="right">${m.guild_b_combo}</td>`;
		html += `<td align="right">${m.guild_a_ship_win}</td>`;
		html += `<td align="right">${m.guild_b_ship_win}</td>`;
		html += generateShinmaCells(m.shinma[0], shinma_skills);
		html += generateShinmaCells(m.shinma[1], shinma_skills);
		html += '</tr>';
	}
	html += '</table>';

	let body = document.getElementsByTagName("body");
	body[0].innerHTML = html;
}

function asyncLoadJson(repo, name) {
	db.json.loadingCount++;
	loadJSON(`https://raw.githubusercontent.com/${repo}/${name}.json`, function(response) {
		db.json[name] = JSON.parse(response);
		onLoadingDone(db);
	})
}

function loadJSON(path, callback) {
	let xobj = new XMLHttpRequest();
	xobj.overrideMimeType("application/json");
	xobj.open('GET', path, true);
	xobj.onreadystatechange = function () {
		if (xobj.readyState == 4 && xobj.status == "200") {
			callback(xobj.responseText);
		}
	};
	xobj.send(null);
}

window.addEventListener('load', function() {
	asyncLoadJson(repo_public_tools, "match_history_Melesie");
	asyncLoadJson(repo_datamine, "ultimate_art_method_mst_list");
});
		</script>
	</body>
</html>
